<?phpif (!defined('BASEPATH')) {	exit('No direct script access allowed');}include_once APPPATH . '/modules/layout/controllers/Layout.php';class Communes extends Layout {	private $_module_slug = 'provinces/communes';	function __construct() {		parent::__construct();		$this->load->library('form_validation');		$this->_data['breadcrumbs_module_name'] = 'Tỉnh thành phố';		$this->_data['module_slug'] = $this->_module_slug;	}	function default_args() {		$order_by = array(						'provinces.pOrder' => 'ASC',			'districts.dOrder' => 'ASC',			'communes.order' => 'ASC',						'communes.name' => 'ASC',		);		$args = array();		$args['order_by'] = $order_by;		return $args;	}	function counts($args) {		return $this->M_communes->counts($args);	}		function gets($options = array()) {		$default_args = $this->default_args();				if(is_array($options) && !empty($options)){			$args = array_merge($default_args, $options);		}else{			$args = $default_args;		}				return $this->M_communes->gets($args);	}	function get($id) {		return $this->M_communes->get($id);	}		function get_max_order() {		$order_by = array(			'communes.order' => 'DESC',		);		$args = array();		$args['order_by'] = $order_by;		$perpage = 1;		$offset = 0;		$rows = $this->M_communes->gets($args, $perpage, $offset);		$max_order = isset($rows[0]['order']) ? $rows[0]['order'] : 0;		return (int) $max_order;	}	function re_order() {		$args = $this->default_args();		$rows = $this->M_communes->gets($args);		if (is_array($rows) && !empty($rows)) {			$i = 0;			foreach ($rows as $value) {				$i++;				$data = array(					'order' => $i,				);				$this->M_communes->update($value['id'], $data);			}		}	}		function ajax_gets() {        if (!$this->input->is_ajax_request()) {            exit('No direct script access allowed');        }        $message = array();        $message['status'] = 'warning';        $message['content'] = null;        $message['message'] = 'Kiểm tra thông tin';        $post = $this->input->post();        if (!empty($post)) {            $id = explode(',', $this->input->post('id'));            $data = $this->gets(array('in_pId' => $id));			$row = modules::run('provinces/get', (int) $this->input->post('id'));			$cost = isset($row['cost']) ? $row['cost'] : 0;            if (isset($data) && is_array($data) && !empty($data)) {				$partial = array();				$partial = array('option_name'=> 'phường/xã', 'data_key'=> 'dId', 'data_value'=> 'dName', 'data' => $data);				$total = formatRice($this->cart->total() + $cost);                $message['status'] = 'success';                $message['content'] = array('cost' => formatRice($cost), 'total' => $total, 'district' => $this->load->view('layout/site/partial/option', $partial, true));                $message['message'] = 'Tải dữ liệu thành công!';            } else {                $message['status'] = 'danger';                $message['content'] = null;                $message['message'] = 'Có lỗi xảy ra! Vui lòng kiểm tra lại!';            }        }        echo json_encode($message);        exit();    }		function ajax_get() {        if (!$this->input->is_ajax_request()) {            exit('No direct script access allowed');        }        $message = array();        $message['status'] = 'warning';        $message['content'] = null;        $message['message'] = 'Kiểm tra thông tin';        $post = $this->input->post();        if (!empty($post)) {            $id = $this->input->post('id');            $data = $this->get($id);			$cost = isset($data['cost']) ? $data['cost'] : 0;            if (isset($data) && is_array($data) && !empty($data)) {				$total = formatRice($this->cart->total() + $cost);                $message['status'] = 'success';                $message['content'] = array('cost' => formatRice($cost), 'total' => $total, 'data' => $data);                $message['message'] = 'Tải dữ liệu thành công!';            } else {                $message['status'] = 'danger';                $message['content'] = null;                $message['message'] = 'Có lỗi xảy ra! Vui lòng kiểm tra lại!';            }        }        echo json_encode($message);        exit();    }	function admin_index() {		$this->_initialize_admin();		$this->redirect_admin();		$this->_plugins_css_admin[] = array(			'folder' => 'bootstrap3-dialog/css',			'name' => 'bootstrap-dialog',		);		$this->_plugins_script_admin[] = array(			'folder' => 'bootstrap3-dialog/js',			'name' => 'bootstrap-dialog',		);		$this->set_plugins_admin();		$this->_modules_script[] = array(			'folder' => 'provinces',			'name' => 'admin-communes-items',		);		$this->set_modules();		$get = $this->input->get();		$this->_data['get'] = $get;		$args = $this->default_args();		if (isset($get['q']) && trim($get['q']) != '') {			$args['q'] = $get['q'];		}				if (isset($get['pId']) && ((int)$get['pId']) != 0) {			$args['in_pId'] = $get['pId'];		}		$total = $this->counts($args);		$perpage = isset($get['per_page']) ? $get['per_page'] : $this->config->item('per_page');		$segment = 4;		$this->load->library('pagination');		$config['total_rows'] = $total;		$config['per_page'] = $perpage;		$config['full_tag_open'] = '<ul class="pagination no-margin pull-right">';		$config['full_tag_close'] = '</ul><!--pagination-->';		$config['first_link'] = '&laquo;';		$config['first_tag_open'] = '<li class="prev page">';		$config['first_tag_close'] = '</li>';		$config['last_link'] = '&raquo;';		$config['last_tag_open'] = '<li class="next page">';		$config['last_tag_close'] = '</li>';		$config['next_link'] = 'Trang trước &rarr;';		$config['next_tag_open'] = '<li class="next page">';		$config['next_tag_close'] = '</li>';		$config['prev_link'] = '&larr; Trang sau';		$config['prev_tag_open'] = '<li class="prev page">';		$config['prev_tag_close'] = '</li>';		$config['cur_tag_open'] = '<li class="active"><a href="">';		$config['cur_tag_close'] = '</a></li>';		$config['num_tag_open'] = '<li class="page">';		$config['num_tag_close'] = '</li>';		if (!empty($get)) {			$config['base_url'] = get_admin_url($this->_module_slug);			$config['suffix'] = '?' . http_build_query($get, '', "&");			$config['first_url'] = get_admin_url($this->_module_slug . '?' . http_build_query($get, '', "&"));			$config['uri_segment'] = $segment;		} else {			$config['base_url'] = get_admin_url($this->_module_slug);			$config['uri_segment'] = $segment;		}		$this->pagination->initialize($config);		$pagination = $this->pagination->create_links();		$offset = ($this->uri->segment($segment) == '') ? 0 : $this->uri->segment($segment);		$rows = $this->M_communes->gets($args, $perpage, $offset);		$this->_data['rows'] = $rows;		$this->_data['pagination'] = $pagination;		/*echo '<pre>';			print_r($rows);			echo '</pre>';		*/				$provinces = modules::run('provinces/provinces/gets');		$this->_data['provinces'] = $provinces;				$districts = NULL;		if(isset($get['dId']) && (int)$get['dId'] != 0){			$districts = modules::run('provinces/districts/gets', array('in_pId' => (int)$get['dId']));		}		$this->_data['districts'] = $districts;		$this->_data['title'] = 'Danh sách phường/xã - ' . $this->config->item('site_name');		$this->_data['main_content'] = 'provinces/admin/view_page_communes_index';		$this->load->view('layout/admin/view_layout', $this->_data);	}	function admin_add() {		$data = array(			'name' => $this->input->post('name'),			'district_id' => filter_var($this->input->post('district_id'), FILTER_SANITIZE_NUMBER_INT),			'cost' => filter_var($this->input->post('cost'), FILTER_SANITIZE_NUMBER_INT),			'order' => $this->get_max_order() + 1,			'created' => time(),			'modified' => 0		);		return $this->M_communes->add($data);	}	function admin_update($id) {		$data = array(			'name' => $this->input->post('name'),			'district_id' => filter_var($this->input->post('district_id'), FILTER_SANITIZE_NUMBER_INT),			'cost' => filter_var($this->input->post('cost'), FILTER_SANITIZE_NUMBER_INT),			'modified' => time()		);		return $this->M_communes->update($id, $data);	}	function admin_delete() {		$this->_initialize_admin();		$this->load->module('users');		$this->_message_success = 'Đã xóa phường/xã!';		$this->_message_warning = 'Phường/xã này không tồn tại!';		if ($this->users->validate_admin_logged_in() == TRUE) {			$id = $this->input->get('id');			if ($id != 0) {				$row = $this->get($id);				if ($this->M_communes->delete($id)) {					//sap xep lai					$this->re_order();					$notify_type = 'success';					$notify_content = $this->_message_success;				} else {					$notify_type = 'danger';					$notify_content = $this->_message_danger;				}			} else {				$notify_type = 'warning';				$notify_content = $this->_message_warning;			}			$this->set_notify_admin($notify_type, $notify_content);			redirect(get_admin_url($this->_module_slug));		} else {			$notify_type = 'danger';			$notify_content = $this->_message_banned;			$this->set_notify_admin($notify_type, $notify_content);			redirect(get_admin_url($this->_module_slug));		}	}	function admin_main() {		$this->_initialize_admin();		$this->redirect_admin();		$post = $this->input->post();		if (!empty($post)) {			$action = $this->input->post('action');			if ($action == 'delete') {				$this->_message_success = 'Đã xóa các phường/xã được chọn!';				$this->_message_warning = 'Bạn chưa chọn phường/xã nào!';				$ids = $this->input->post('idcheck');				if (is_array($ids) && !empty($ids)) {					foreach ($ids as $id) {						$current_photo = $this->get($id);						if ($this->M_communes->delete($id)) {							$notify_type = 'success';							$notify_content = $this->_message_success;						} else {							$notify_type = 'danger';							$notify_content = $this->_message_danger;						}					}					//sap xep lai					$this->re_order();				} else {					$notify_type = 'warning';					$notify_content = $this->_message_warning;				}				$this->set_notify_admin($notify_type, $notify_content);				redirect(get_admin_url($this->_module_slug));			} elseif ($action == 'content') {				redirect(get_admin_url($this->_module_slug . '/content'));			} elseif ($action == 'update') {				$this->_message_success = 'Đã cập nhật các phường/xã!';				$this->_message_warning = 'Không có phường/xã nào để cập nhật!';				$ids = $this->input->post('ids');				$orders = $this->input->post('order');				$count = count($orders);				if (!empty($ids) && !empty($orders)) {					for ($i = 0; $i < $count; $i++) {						$data = array(							'dOrder' => $orders[$i],						);						$id = $ids[$i];						if ($this->M_communes->update($id, $data)) {							$notify_type = 'success';							$notify_content = $this->_message_success;							$this->output->clearCache();						} else {							$notify_type = 'danger';							$notify_content = $this->_message_danger;						}					}				} else {					$notify_type = 'warning';					$notify_content = $this->_message_warning;				}				$this->set_notify_admin($notify_type, $notify_content);				redirect(get_admin_url($this->_module_slug));			}		} else {			redirect(get_admin_url($this->_module_slug));		}	}	function admin_content() {		$this->_initialize_admin();		$this->redirect_admin();		$this->_plugins_script_admin[] = array(			'folder' => 'jquery-validation',			'name' => 'jquery.validate',		);		$this->_plugins_script_admin[] = array(			'folder' => 'jquery-validation/localization',			'name' => 'messages_vi',		);		$this->set_plugins_admin();		$this->_modules_script[] = array(			'folder' => 'provinces',			'name' => 'admin-communes-content-validate',		);		$this->set_modules();		$post = $this->input->post();		if (!empty($post)) {			$this->form_validation->set_error_delimiters('<span class="help-block">', '</span>');			$this->form_validation->set_rules('name', 'Tên phường/xã', 'trim|required');			if ($this->form_validation->run($this)) {				if ($this->input->post('id')) {//update					$err = FALSE;					$id = $this->input->post('id');					if (!$this->admin_update($id)) {						$err = TRUE;					}					if ($err === FALSE) {						$this->output->clearCache();						$notify_type = 'success';						$notify_content = 'Cập nhật phường/xã thành công!';						$this->set_notify_admin($notify_type, $notify_content);						redirect(get_admin_url($this->_module_slug));					} else {						$notify_type = 'danger';						$notify_content = 'Có lỗi xảy ra!';						$this->set_notify_admin($notify_type, $notify_content);					}				} else {//add					$err = FALSE;					$insert_id = $this->admin_add();					if ($insert_id == 0) {						$err = TRUE;					}					if ($err === FALSE) {						$this->output->clearCache();						$notify_type = 'success';						$notify_content = 'Phường/xã đã được thêm!';						$this->set_notify_admin($notify_type, $notify_content);						redirect(get_admin_url($this->_module_slug));					} else {						$notify_type = 'danger';						$notify_content = 'Có lỗi xảy ra!';						$this->set_notify_admin($notify_type, $notify_content);					}				}			}		}		$title = 'Thêm phường/xã - ' . $this->_data['breadcrumbs_module_name'] . ' - ' . $this->config->item('site_name');		$provinces = modules::run('provinces/provinces/gets');		$this->_data['provinces'] = $provinces;		$parent_district_id = isset($provinces[0]['pId']) ? $provinces[0]['pId'] : 0;				$id = ($this->uri->segment(5) == '') ? 0 : $this->uri->segment(5);				if ($id != 0) {			$row = $this->get($id);			$parent_district_id = isset($row['pId']) ? $row['pId'] : 0;			$this->_data['row'] = $row;			$title = 'Cập nhật phường/xã - ' . $this->_data['breadcrumbs_module_name'] . ' - ' . $this->config->item('site_name');		}				//var_dump($parent_district_id); die;		$districts = modules::run('provinces/districts/gets', array('in_pId' => $parent_district_id));		$this->_data['districts'] = $districts;		$this->_data['title'] = $title;		$this->_data['main_content'] = 'provinces/admin/view_page_communes_content';		$this->load->view('layout/admin/view_layout', $this->_data);	}}/* End of file communes.php *//* Location: ./application/modules/provinces/controllers/communes.php */